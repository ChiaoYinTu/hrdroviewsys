<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å¾®æ°´åŠ›ç³»çµ±èƒ½æºæµå‹•ç›£æ§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #map {
            height: 180px;
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .flow-chart {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            padding: 35px 20px;
            background: linear-gradient(135deg, #87CEEB 0%, #4682B4 100%);
            border-radius: 15px;
            margin: 15px 0;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            min-height: 280px;
        }

        .node {
            text-align: center;
            padding: 12px;
            border: 3px solid #3498db;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 170px;
            height: 260px;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            z-index: 10;
        }

        .node:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-top: 20px solid transparent;
            border-bottom: 20px solid transparent;
            border-left: 40px solid #2980b9;
            animation: flow 2s infinite ease-in-out;
            z-index: 5;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.2));
        }

        @keyframes flow {
            0% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.3; transform: scale(0.8); }
        }

        .arrow.first {
            left: calc(170px + 12px + 20px); /* node width + padding + margin */
            top: 50%;
            transform: translateY(-50%);
        }

        .arrow.second {
            right: calc(170px + 12px + 20px); /* node width + padding + margin */
            top: 50%;
            transform: translateY(-50%);
        }

        .chart-container {
            height: 280px;
            width: 100%;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #battery {
            width: 50px;
            height: 80px;
            border: 3px solid #2c3e50;
            border-radius: 5px;
            position: relative;
            margin: 10px auto;
            background: #ecf0f1;
        }

        #battery-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            transition: height 0.8s ease, background-color 0.8s ease;
            border-radius: 0 0 2px 2px;
        }

        #battery-head {
            width: 20px;
            height: 8px;
            background: #2c3e50;
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px 2px 0 0;
        }

        .data-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 18px;
            border-radius: 15px;
            margin-top: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .real-time-data {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .data-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .data-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .data-item label {
            font-size: 14px;
            color: #6c757d;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .data-item span {
            font-size: 18px;
            color: #2c3e50;
            font-weight: bold;
        }

        h2, p, span {
            font-weight: bold;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }

        .vendor-logo {
            max-height: 70px;
            width: auto;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.1));
        }

        .waesco-logo {
            max-height: 150px;
            width: auto;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.1));
        }

        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            justify-content: space-between;
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .update-time {
            font-size: 14px;
            font-weight: bold;
            color: #495057;
        }

        .middle-section {
            display: flex;
            justify-content: space-between;
            width: 100%;
            gap: 30px;
            flex-wrap: wrap;
        }

        .flow-chart {
            flex: 1;
            min-width: 600px;
        }

        .data-box {
            flex: 1;
            max-width: 400px;
            min-width: 350px;
        }

        .grid {
            margin-top: 20px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-online {
            background-color: #28a745;
        }

        .status-warning {
            background-color: #ffc107;
        }

        .status-error {
            background-color: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .middle-section {
                flex-direction: column;
            }

            .flow-chart {
                min-width: 100%;
                padding: 20px 10px;
            }

            .node {
                width: 120px;
                height: 200px;
                padding: 10px;
            }

            .arrow.first {
                left: calc(120px + 10px + 15px);
            }

            .arrow.second {
                right: calc(120px + 10px + 15px);
            }

            .real-time-data {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 20px;
            }

            .vendor-logo, .waesco-logo {
                max-height: 50px;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen">
    <div class="container mx-auto p-4">
        <div class="header">
            <img src="https://raw.githubusercontent.com/ChiaoYinTu/hrdroviewsys/main/rihding-logo-01.svg" alt="Vendor Logo" class="vendor-logo">
            <h1>å¾®æ°´åŠ›ç³»çµ±èƒ½æºæµå‹•ç›£æ§</h1>
            <img src="https://raw.githubusercontent.com/ChiaoYinTu/hrdroviewsys/main/WAESCO_LAB_Logo2-removebg.png" alt="WAESCO Lab Logo" class="waesco-logo">
        </div>

        <div class="refresh-controls">
            <div class="flex items-center gap-3">
                <span class="status-indicator status-online"></span>
                <label for="modeSelect">æ¨¡å¼ï¼š</label>
                <select id="modeSelect" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="demo">å±•ç¤ºæ¨¡å¼</option>
                    <option value="thingspeak">ThingSpeakæ¨¡å¼</option>
                    <option value="mssql">MSSQLæ¨¡å¼</option>
                </select>
                <label for="refreshInterval">è‡ªå‹•åˆ·æ–°é–“éš”ï¼š</label>
                <select id="refreshInterval" class="px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="5000">5ç§’</option>
                    <option value="10000">10ç§’</option>
                    <option value="30000">30ç§’</option>
                    <option value="60000">60ç§’</option>
                </select>
                <button id="forceRefresh" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">å¼·åˆ¶åˆ·æ–°</button>
            </div>
            <div class="update-time">æ›´æ–°æ™‚é–“: <span id="updateTime">2025-08-14 18:27:00</span> (CST)</div>
        </div>

        <div id="thingspeakConfig" class="bg-white p-4 rounded-lg shadow mb-4" style="display: none;">
            <h3 class="text-lg font-semibold mb-2">ThingSpeak é…ç½®</h3>
            <div class="flex flex-col gap-2">
                <label for="channelId">Channel ID:</label>
                <input id="channelId" type="text" class="px-3 py-2 border border-gray-300 rounded-lg" placeholder="è¼¸å…¥ ThingSpeak Channel ID">
                <label for="apiKey">Read API Key:</label>
                <input id="apiKey" type="text" class="px-3 py-2 border border-gray-300 rounded-lg" placeholder="è¼¸å…¥ Read API Key">
                <label class="text-sm text-gray-600">å‡è¨­ ThingSpeak fields å°æ‡‰ï¼šfield1: power (kW), field2: soc (%), field3: batteryPower (W), field4: flowSpeed (m/s), field5: waterLevel (m), field6: voltage (V), field7: current (A)</label>
                <button id="saveThingspeakConfig" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <div id="mssqlConfig" class="bg-white p-4 rounded-lg shadow mb-4" style="display: none;">
            <h3 class="text-lg font-semibold mb-2">MSSQL é…ç½®</h3>
            <div class="flex flex-col gap-2">
                <label for="mssqlServer">ä¼ºæœå™¨åœ°å€:</label>
                <input id="mssqlServer" type="text" class="px-3 py-2 border border-gray-300 rounded-lg" placeholder="è¼¸å…¥ MSSQL ä¼ºæœå™¨åœ°å€ (å¦‚ localhost)">
                <label for="mssqlDatabase">è³‡æ–™åº«åç¨±:</label>
                <input id="mssqlDatabase" type="text" class="px-3 py-2 border border-gray-300 rounded-lg" placeholder="è¼¸å…¥è³‡æ–™åº«åç¨±">
                <label for="mssqlUser">ä½¿ç”¨è€…åç¨±:</label>
                <input id="mssqlUser" type="text" class="px-3 py-2 border border-gray-300 rounded-lg" placeholder="è¼¸å…¥ä½¿ç”¨è€…åç¨±">
                <label for="mssqlPassword">å¯†ç¢¼:</label>
                <input id="mssqlPassword" type="password" class="px-3 py-2 border border-gray-300 rounded-lg" placeholder="è¼¸å…¥å¯†ç¢¼">
                <label for="mssqlTable">è³‡æ–™è¡¨åç¨±:</label>
                <input id="mssqlTable" type="text" class="px-3 py-2 border border-gray-300 rounded-lg" placeholder="è¼¸å…¥è³‡æ–™è¡¨åç¨±">
                <label class="text-sm text-gray-600">å‡è¨­è³‡æ–™è¡¨æ¬„ä½å°æ‡‰ï¼špower (kW), soc (%), batteryPower (W), flowSpeed (m/s), waterLevel (m), voltage (V), current (A)</label>
                <button id="saveMssqlConfig" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <div id="map"></div>

        <div class="middle-section">
            <div class="flow-chart">
                <div class="node">
                    <img src="https://raw.githubusercontent.com/ChiaoYinTu/hrdroviewsys/main/hydro-power.png" alt="Hydro" style="width: 80px; height: 80px; margin: 0;">
                    <p style="font-size: 16px; color: #2c3e50; margin: 5px 0;">å¾®æ°´åŠ›ç™¼é›»æ©Ÿ</p>
                    <div style="font-size: 14px; color: #7f8c8d;">ç™¼é›»é‡</div>
                    <p style="font-size: 20px; color: #e74c3c; font-weight: bold;"><span id="power">1.5 kW</span></p>
                </div>

                <div class="arrow first"></div>

                <div class="node">
                    <img src="https://raw.githubusercontent.com/ChiaoYinTu/hrdroviewsys/main/home-control.png" alt="House" style="width: 60px; height: 60px; margin: 0;">
                                        <p style="font-size: 16px; color: #2c3e50; margin: 5px 0;">ä¸­æ§å®¤</p>
                    <div id="battery">
                        <div id="battery-head"></div>
                        <div id="battery-fill" style="height: 87%;"></div>
                    </div>
                    <div style="font-size: 12px; color: #7f8c8d;">é›»æ± ç‹€æ…‹</div>
                    <p style="font-size: 16px; color: #27ae60; font-weight: bold;"><span id="soc">87%</span></p>
                    <p style="font-size: 12px; color: #7f8c8d;">(<span id="batteryPower">662 W</span>)</p>
                </div>

                <div class="arrow second"></div>

                <div class="node">
                    <img src="https://raw.githubusercontent.com/ChiaoYinTu/hrdroviewsys/main/electric-appliances.png" alt="Load" style="width: 90px; height: 90px; margin: 0;">
                    <p style="font-size: 16px; color: #2c3e50; margin: 5px 0;">è² è¼‰è¨­å‚™</p>
                    <div style="font-size: 14px; color: #7f8c8d;">ç”¨é›»é‡</div>
                    <p style="font-size: 20px; color: #f39c12; font-weight: bold;">250 W</p>
                </div>
            </div>

            <div class="data-box">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">ğŸ“Š å³æ™‚æ•¸æ“šç›£æ§</h2>
                <div class="real-time-data">
                    <div class="data-item">
                        <label>ğŸ’§ æ°´æµé€Ÿåº¦:</label>
                        <span id="flowSpeed">2.5 m/s</span>
                    </div>
                    <div class="data-item">
                        <label>âš¡ ç™¼é›»åŠŸç‡:</label>
                        <span id="powerDisplay">1.5 kW</span>
                    </div>
                    <div class="data-item">
                        <label>ğŸ“ æ°´ä½é«˜åº¦:</label>
                        <span id="waterLevel">3.8 m</span>
                    </div>
                    <div class="data-item">
                        <label>ğŸ”‹ ç³»çµ±é›»å£“:</label>
                        <span id="voltage">24.5 V</span>
                    </div>
                    <div class="data-item">
                        <label>ğŸ”Œ è¼¸å‡ºé›»æµ:</label>
                        <span id="current">10.2 A</span>
                    </div>
                    <div class="data-item">
                        <label>ğŸ”‹ é›»æ± å®¹é‡(SOC):</label>
                        <span id="socDisplay">87%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="chart-container">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">ç™¼é›»é‡è¶¨å‹¢åœ–</h2>
                <canvas id="powerChart"></canvas>
            </div>
            <div class="chart-container">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">é›»æ± SOCè¶¨å‹¢åœ–</h2>
                <canvas id="socChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–åœ°åœ–
        let map = L.map('map').setView([25.05042495, 121.2570054], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let marker = L.marker([25.05042495, 121.2570054], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            })
        }).addTo(map).bindPopup('å¾®æ°´åŠ›ç™¼é›»ç«™ä½ç½®');

        // åˆå§‹åŒ– Chart.js åœ–è¡¨
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'æ™‚é–“',
                        font: { size: 14 }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            },
            elements: {
                line: {
                    tension: 0.4
                },
                point: {
                    radius: 3,
                    hoverRadius: 6
                }
            }
        };

        let powerChart = new Chart(document.getElementById("powerChart"), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'ç™¼é›»é‡ (kW)',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    borderWidth: 2
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    ...chartConfig.scales,
                    y: {
                        ...chartConfig.scales.y,
                        title: {
                            display: true,
                            text: 'kW',
                            font: { size: 14 }
                        }
                    }
                }
            }
        });

        let socChart = new Chart(document.getElementById("socChart"), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'SOC (%)',
                    data: [],
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    fill: true,
                    borderWidth: 2
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    ...chartConfig.scales,
                    y: {
                        ...chartConfig.scales.y,
                        title: {
                            display: true,
                            text: '%',
                            font: { size: 14 }
                        },
                        max: 100
                    }
                }
            }
        });

        // æ¨¡å¼èˆ‡é…ç½®
        let mode = 'demo';
        let thingspeakChannelId = '';
        let thingspeakApiKey = '';
        let mssqlConfig = {
            server: '',
            database: '',
            user: '',
            password: '',
            table: ''
        };
        const DEMO_API_URL = 'http://localhost:3000/api/data';
        let lastData = null;
        let connectionStatus = true;

        // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
        function updateStatusIndicator(online) {
            const indicator = document.querySelector('.status-indicator');
            if (online) {
                indicator.className = 'status-indicator status-online';
            } else {
                indicator.className = 'status-indicator status-error';
            }
            connectionStatus = online;
        }

        // æ›´æ–°é›»æ± é¡è‰²
        function updateBatteryColor(soc) {
            const batteryFill = document.getElementById('battery-fill');
            if (soc < 20) {
                batteryFill.style.backgroundColor = '#e74c3c';
            } else if (soc <= 50) {
                batteryFill.style.backgroundColor = '#f39c12';
            } else if (soc <= 80) {
                batteryFill.style.backgroundColor = '#f1c40f';
            } else {
                batteryFill.style.backgroundColor = '#27ae60';
            }
        }

        // æ¸…ç©ºæ•¸æ“š
        function clearData() {
            powerChart.data.labels = [];
            powerChart.data.datasets[0].data = [];
            powerChart.update();
            socChart.data.labels = [];
            socChart.data.datasets[0].data = [];
            socChart.update();
            lastData = null;

            // é‡ç½®é¡¯ç¤ºå€¼ç‚ºé è¨­æˆ–ç©ºç™½
            document.getElementById('power').textContent = '0 kW';
            document.getElementById('powerDisplay').textContent = '0 kW';
            document.getElementById('soc').textContent = '0%';
            document.getElementById('socDisplay').textContent = '0%';
            document.getElementById('batteryPower').textContent = '0 W';
            document.getElementById('flowSpeed').textContent = '0 m/s';
            document.getElementById('waterLevel').textContent = '0 m';
            document.getElementById('voltage').textContent = '0 V';
            document.getElementById('current').textContent = '0 A';
            const batteryFill = document.getElementById('battery-fill');
            batteryFill.style.height = '0%';
            updateBatteryColor(0);
        }

        // æ›´æ–°æ•¸æ“šçš„å‡½æ•¸
        async function updateData() {
            let apiUrl = DEMO_API_URL;
            let isThingspeak = false;
            let isMssql = false;

            if (mode === 'thingspeak') {
                if (!thingspeakChannelId || !thingspeakApiKey) {
                    alert('è«‹å…ˆé…ç½® ThingSpeak Channel ID å’Œ API Key');
                    return;
                }
                apiUrl = `https://api.thingspeak.com/channels/${thingspeakChannelId}/feeds/last.json?api_key=${thingspeakApiKey}`;
                isThingspeak = true;
            } else if (mode === 'mssql') {
                if (!mssqlConfig.server || !mssqlConfig.database || !mssqlConfig.user || !mssqlConfig.table) {
                    alert('è«‹å…ˆé…ç½® MSSQL ä¼ºæœå™¨åœ°å€ã€è³‡æ–™åº«åç¨±ã€ä½¿ç”¨è€…åç¨±å’Œè³‡æ–™è¡¨åç¨±');
                    return;
                }
                apiUrl = '/api/mssql'; // å‡è¨­å¾Œç«¯æä¾› MSSQL API ç«¯é»
                isMssql = true;
            }

            try {
                let response;
                let data;

                if (isMssql) {
                    // MSSQL éœ€è¦å¾Œç«¯ API æ”¯æ´
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            server: mssqlConfig.server,
                            database: mssqlConfig.database,
                            user: mssqlConfig.user,
                            password: mssqlConfig.password,
                            table: mssqlConfig.table
                        })
                    });
                } else {
                    response = await fetch(apiUrl);
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const rawData = await response.json();

                if (isThingspeak) {
                    data = {
                        power: parseFloat(rawData.field1) || 0,
                        soc: parseInt(rawData.field2) || 0,
                        batteryPower: parseInt(rawData.field3) || 0,
                        flowSpeed: parseFloat(rawData.field4) || 0,
                        waterLevel: parseFloat(rawData.field5) || 0,
                        voltage: parseFloat(rawData.field6) || 0,
                        current: parseFloat(rawData.field7) || 0
                    };
                } else if (isMssql) {
                    // å‡è¨­å¾Œç«¯è¿”å›çš„æ•¸æ“šæ ¼å¼èˆ‡å…¶ä»–æ¨¡å¼ä¸€è‡´
                    data = rawData;
                } else {
                    data = rawData;
                }

                updateStatusIndicator(true);

                if (data) {
                    const newPower = parseFloat(data.power) || 0;
                    const newSoc = parseInt(data.soc) || 0;
                    const batteryPower = parseInt(data.batteryPower) || 0;
                    const flowSpeed = parseFloat(data.flowSpeed) || 0;
                    const waterLevel = parseFloat(data.waterLevel) || 0;
                    const voltage = parseFloat(data.voltage) || 0;
                    const current = parseFloat(data.current) || 0;

                    // æ›´æ–°é¡¯ç¤ºæ•¸æ“š
                    document.getElementById('power').textContent = newPower.toFixed(1) + ' kW';
                    document.getElementById('powerDisplay').textContent = newPower.toFixed(1) + ' kW';
                    document.getElementById('soc').textContent = newSoc + '%';
                    document.getElementById('socDisplay').textContent = newSoc + '%';
                    document.getElementById('batteryPower').textContent = batteryPower + ' W';
                    document.getElementById('flowSpeed').textContent = flowSpeed.toFixed(1) + ' m/s';
                    document.getElementById('waterLevel').textContent = waterLevel.toFixed(1) + ' m';
                    document.getElementById('voltage').textContent = voltage.toFixed(1) + ' V';
                    document.getElementById('current').textContent = current.toFixed(1) + ' A';

                    // æ›´æ–°é›»æ± é¡¯ç¤º
                    const batteryFill = document.getElementById('battery-fill');
                    batteryFill.style.height = newSoc + '%';
                    updateBatteryColor(newSoc);

                    // æª¢æŸ¥æ•¸æ“šæ˜¯å¦æœ‰æ›´æ–°
                    const isDataUpdated = !lastData ||
                        newPower !== parseFloat(lastData.power) ||
                        newSoc !== parseInt(lastData.soc) ||
                        batteryPower !== parseInt(lastData.batteryPower) ||
                        flowSpeed !== parseFloat(lastData.flowSpeed) ||
                        waterLevel !== parseFloat(lastData.waterLevel) ||
                        voltage !== parseFloat(lastData.voltage) ||
                        current !== parseFloat(lastData.current);

                    if (isDataUpdated) {
                        const currentTime = new Date().toLocaleTimeString('zh-TW', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });

                        // æ›´æ–°åœ–è¡¨
                        powerChart.data.labels.push(currentTime);
                        powerChart.data.datasets[0].data.push(newPower);
                        socChart.data.labels.push(currentTime);
                        socChart.data.datasets[0].data.push(newSoc);

                        // é™åˆ¶æ•¸æ“šé»æ•¸é‡
                        const maxDataPoints = 50;
                        if (powerChart.data.labels.length > maxDataPoints) {
                            powerChart.data.labels.shift();
                            powerChart.data.datasets[0].data.shift();
                            socChart.data.labels.shift();
                            socChart.data.datasets[0].data.shift();
                        }

                        powerChart.update('none');
                        socChart.update('none');
                    }

                    // æ›´æ–°æ™‚é–“æˆ³
                    const updateTime = new Date().toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    document.getElementById('updateTime').textContent = updateTime;
                    lastData = { ...data };
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                updateStatusIndicator(false);

                // å¦‚æœAPIä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ“¬æ•¸æ“šï¼ˆåƒ…åœ¨å±•ç¤ºæ¨¡å¼ï¼‰
                if (mode === 'demo') {
                    generateSimulatedData();
                }
            }
        }

        // ç”Ÿæˆæ¨¡æ“¬æ•¸æ“šï¼ˆç”¨æ–¼æ¼”ç¤ºï¼‰
        function generateSimulatedData() {
            const simulatedData = {
                power: (Math.random() * 2 + 0.5).toFixed(1),
                soc: Math.floor(Math.random() * 30 + 70),
                batteryPower: Math.floor(Math.random() * 200 + 500),
                flowSpeed: (Math.random() * 1 + 2).toFixed(1),
                waterLevel: (Math.random() * 0.5 + 3.5).toFixed(1),
                voltage: (Math.random() * 2 + 23.5).toFixed(1),
                current: (Math.random() * 2 + 9).toFixed(1)
            };

            const newPower = parseFloat(simulatedData.power);
            const newSoc = parseInt(simulatedData.soc);
            const batteryPower = parseInt(simulatedData.batteryPower);
            const flowSpeed = parseFloat(simulatedData.flowSpeed);
            const waterLevel = parseFloat(simulatedData.waterLevel);
            const voltage = parseFloat(simulatedData.voltage);
            const current = parseFloat(simulatedData.current);

            document.getElementById('power').textContent = newPower + ' kW';
            document.getElementById('powerDisplay').textContent = newPower + ' kW';
            document.getElementById('soc').textContent = newSoc + '%';
            document.getElementById('socDisplay').textContent = newSoc + '%';
            document.getElementById('batteryPower').textContent = batteryPower + ' W';
            document.getElementById('flowSpeed').textContent = flowSpeed + ' m/s';
            document.getElementById('waterLevel').textContent = waterLevel + ' m';
            document.getElementById('voltage').textContent = voltage + ' V';
            document.getElementById('current').textContent = current + ' A';

            const batteryFill = document.getElementById('battery-fill');
            batteryFill.style.height = newSoc + '%';
            updateBatteryColor(newSoc);

            const currentTime = new Date().toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            powerChart.data.labels.push(currentTime);
            powerChart.data.datasets[0].data.push(newPower);
            socChart.data.labels.push(currentTime);
            socChart.data.datasets[0].data.push(newSoc);

            if (powerChart.data.labels.length > 50) {
                powerChart.data.labels.shift();
                powerChart.data.datasets[0].data.shift();
                socChart.data.labels.shift();
                socChart.data.datasets[0].data.shift();
            }

            powerChart.update('none');
            socChart.update('none');

            const updateTime = new Date().toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('updateTime').textContent = updateTime;
        }

        // è¨­ç½®è‡ªå‹•åˆ·æ–°
        let refreshInterval = 15000;
        let intervalId = setInterval(updateData, refreshInterval);

        document.getElementById('refreshInterval').addEventListener('change', function() {
            refreshInterval = parseInt(this.value);
            clearInterval(intervalId);
            intervalId = setInterval(updateData, refreshInterval);
        });

        document.getElementById('forceRefresh').addEventListener('click', function() {
            this.textContent = 'åˆ·æ–°ä¸­...';
            this.disabled = true;
            updateData().finally(() => {
                this.textContent = 'å¼·åˆ¶åˆ·æ–°';
                this.disabled = false;
            });
        });

        // æ¨¡å¼åˆ‡æ›
        document.getElementById('modeSelect').addEventListener('change', function() {
            mode = this.value;
            clearData(); // åˆ‡æ›æ™‚æ´—æ‰æ•¸æ“š
            if (mode === 'thingspeak') {
                document.getElementById('thingspeakConfig').style.display = 'block';
                document.getElementById('mssqlConfig').style.display = 'none';
            } else if (mode === 'mssql') {
                document.getElementById('thingspeakConfig').style.display = 'none';
                document.getElementById('mssqlConfig').style.display = 'block';
            } else {
                document.getElementById('thingspeakConfig').style.display = 'none';
                document.getElementById('mssqlConfig').style.display = 'none';
            }
            updateData();
        });

        // ä¿å­˜ ThingSpeak é…ç½®
        document.getElementById('saveThingspeakConfig').addEventListener('click', function() {
            thingspeakChannelId = document.getElementById('channelId').value.trim();
            thingspeakApiKey = document.getElementById('apiKey').value.trim();
            if (thingspeakChannelId && thingspeakApiKey) {
                alert('ThingSpeak é…ç½®å·²ä¿å­˜');
                updateData();
            } else {
                alert('è«‹è¼¸å…¥ Channel ID å’Œ API Key');
            }
        });

        // ä¿å­˜ MSSQL é…ç½®
        document.getElementById('saveMssqlConfig').addEventListener('click', function() {
            mssqlConfig.server = document.getElementById('mssqlServer').value.trim();
            mssqlConfig.database = document.getElementById('mssqlDatabase').value.trim();
            mssqlConfig.user = document.getElementById('mssqlUser').value.trim();
            mssqlConfig.password = document.getElementById('mssqlPassword').value.trim();
            mssqlConfig.table = document.getElementById('mssqlTable').value.trim();
            if (mssqlConfig.server && mssqlConfig.database && mssqlConfig.user && mssqlConfig.table) {
                alert('MSSQL é…ç½®å·²ä¿å­˜');
                updateData();
            } else {
                alert('è«‹è¼¸å…¥æ‰€æœ‰ MSSQL é…ç½®æ¬„ä½');
            }
        });

        // åˆå§‹åŠ è¼‰
        updateData();
    </script>
</body>
</html>